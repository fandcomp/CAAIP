<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CAAIP CMS</title>
    <link rel="icon" href="/favicon.svg" />
    <link rel="cms-config-url" href="/admin/config.yml" />
    <!-- Netlify Identity widget (required for git-gateway login UI) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <script>
      // Initialize Netlify Identity with your Netlify site URL
      if (window.netlifyIdentity) {
        window.netlifyIdentity.init({
          APIUrl: 'https://caaip.netlify.app/.netlify/identity'
        });
      }
      
      // Refresh page after a successful Identity login so CMS picks up the session
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', function(user){
          if (!user) {
            window.netlifyIdentity.on('login', function(){ document.location.reload(); });
          }
        });
      }
    </script>
    <!-- Load Decap CMS from jsDelivr (pinned) -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.8.4/dist/decap-cms.js"></script>
    
    <!-- Admin Security Panel Widget -->
    <script>
      // Create Security Panel in CMS Dashboard
      CMS.registerEventListener({
        name: 'loginSuccess',
        handler: () => {
          console.log('Admin logged in successfully');
          
          // Wait for CMS to fully load
          setTimeout(() => {
            addSecurityPanel();
          }, 2000);
        }
      });

      function addSecurityPanel() {
        // Check if panel already exists
        if (document.getElementById('security-panel')) return;

        // Get CMS container
        const cmsContainer = document.querySelector('[class*="App"]') || document.body;
        
        // Create panel
        const panel = document.createElement('div');
        panel.id = 'security-panel';
        panel.innerHTML = `
          <div style="
            position: fixed;
            top: 60px;
            right: 20px;
            background: white;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 99999;
            min-width: 300px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h3 style="margin: 0; font-size: 16px; color: #0066cc;">
                ğŸ” Panel Keamanan
              </h3>
              <button onclick="this.closest('#security-panel').style.display='none'" 
                style="background: none; border: none; font-size: 20px; cursor: pointer; color: #999;">
                Ã—
              </button>
            </div>
            
            <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 4px;">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Status Pendaftaran:</div>
              <div id="registration-status" style="font-weight: bold; font-size: 14px; color: #0066cc;">
                ğŸ”„ Loading...
              </div>
            </div>

            <div style="margin-bottom: 15px;">
              <a href="https://app.netlify.com/sites/caaip/settings/identity" 
                 target="_blank"
                 style="
                   display: block;
                   width: 100%;
                   padding: 10px;
                   background: #0066cc;
                   color: white;
                   text-align: center;
                   text-decoration: none;
                   border-radius: 4px;
                   font-size: 13px;
                   font-weight: 500;
                   box-sizing: border-box;
                 ">
                âš™ï¸ Toggle Sign Up (Netlify)
              </a>
            </div>

            <div style="margin-bottom: 15px;">
              <a href="https://app.netlify.com/sites/caaip/identity" 
                 target="_blank"
                 style="
                   display: block;
                   width: 100%;
                   padding: 10px;
                   background: #28a745;
                   color: white;
                   text-align: center;
                   text-decoration: none;
                   border-radius: 4px;
                   font-size: 13px;
                   font-weight: 500;
                   box-sizing: border-box;
                 ">
                ğŸ‘¥ Kelola User
              </a>
            </div>

            <div style="margin-bottom: 10px;">
              <a href="https://app.netlify.com/sites/caaip/identity#invite" 
                 target="_blank"
                 style="
                   display: block;
                   width: 100%;
                   padding: 10px;
                   background: #17a2b8;
                   color: white;
                   text-align: center;
                   text-decoration: none;
                   border-radius: 4px;
                   font-size: 13px;
                   font-weight: 500;
                   box-sizing: border-box;
                 ">
                âœ‰ï¸ Undang User Baru
              </a>
            </div>

            <div style="margin-bottom: 10px;">
              <a href="/admin/security.html" 
                 target="_blank"
                 style="
                   display: block;
                   width: 100%;
                   padding: 10px;
                   background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                   color: white;
                   text-align: center;
                   text-decoration: none;
                   border-radius: 4px;
                   font-size: 13px;
                   font-weight: 500;
                   box-sizing: border-box;
                 ">
                ğŸ›¡ï¸ Panel Keamanan Lengkap
              </a>
            </div>

            <div style="font-size: 11px; color: #999; margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee;">
              ğŸ’¡ Tip: Set ke "Invite Only" untuk keamanan maksimal
            </div>
          </div>
        `;

        cmsContainer.appendChild(panel);

        // Try to detect registration status (best effort)
        checkRegistrationStatus();
      }

      function checkRegistrationStatus() {
        const statusEl = document.getElementById('registration-status');
        if (!statusEl) return;

        // Since we can't directly check via API, we show instructions
        statusEl.innerHTML = `
          <div style="font-size: 13px;">
            <div style="margin-bottom: 5px;">
              ğŸ”’ <strong>Invite Only</strong> = AMAN âœ…<br>
              <span style="font-size: 11px; color: #666;">Hanya admin yang bisa undang user</span>
            </div>
            <div>
              ğŸ”“ <strong>Open</strong> = TIDAK AMAN âŒ<br>
              <span style="font-size: 11px; color: #666;">Siapa saja bisa daftar</span>
            </div>
          </div>
        `;
      }

      // Add panel when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(addSecurityPanel, 2000);
        });
      } else {
        setTimeout(addSecurityPanel, 2000);
      }
    </script>
    
    <!-- Custom CSV Upload Widget -->
    <script>
      // Wait for CMS to be ready
      CMS.registerEventListener({
        name: 'preSave',
        handler: ({ entry }) => {
          console.log('Saving entry:', entry);
          return entry;
        }
      });

      // Custom CSV Upload Widget for Alumni
      var CSVAlumniWidget = createClass({
        getInitialState: function() {
          return {
            value: this.props.value || [],
            csvFile: null,
            error: null
          };
        },

        handleFileUpload: function(e) {
          var file = e.target.files[0];
          if (!file) return;

          if (!file.name.endsWith('.csv')) {
            this.setState({ error: 'File harus berformat .csv' });
            return;
          }

          var reader = new FileReader();
          var self = this;

          reader.onload = function(event) {
            try {
              var csv = event.target.result;
              var lines = csv.split('\n').filter(line => line.trim());
              
              // Skip header (first line)
              var dataLines = lines.slice(1);
              
              // Parse CSV with semicolon delimiter
              var parsedData = dataLines.map(function(line, index) {
                var cols = line.split(';').map(col => col.trim());
                return {
                  no: cols[0] || (index + 1).toString(),
                  name: cols[1] || '',
                  program: cols[2] || ''
                };
              }).filter(item => item.name); // Filter out empty names

              self.setState({ 
                value: parsedData,
                error: null,
                csvFile: file.name
              });
              
              // Update CMS value
              self.props.onChange(parsedData);
            } catch (err) {
              self.setState({ error: 'Error parsing CSV: ' + err.message });
            }
          };

          reader.onerror = function() {
            self.setState({ error: 'Error reading file' });
          };

          reader.readAsText(file);
        },

        handleEdit: function(index, field, newValue) {
          var newData = this.state.value.slice();
          newData[index][field] = newValue;
          this.setState({ value: newData });
          this.props.onChange(newData);
        },

        handleDelete: function(index) {
          var newData = this.state.value.filter((_, i) => i !== index);
          this.setState({ value: newData });
          this.props.onChange(newData);
        },

        handleAdd: function() {
          var newData = this.state.value.slice();
          newData.push({
            no: (newData.length + 1).toString(),
            name: '',
            program: ''
          });
          this.setState({ value: newData });
          this.props.onChange(newData);
        },

        render: function() {
          var self = this;
          var data = this.state.value || [];

          return h('div', { style: { padding: '15px', border: '1px solid #ddd', borderRadius: '4px' } },
            // Upload Section
            h('div', { style: { marginBottom: '20px' } },
              h('label', { 
                style: { 
                  display: 'block',
                  padding: '30px',
                  border: '2px dashed #0066cc',
                  borderRadius: '8px',
                  textAlign: 'center',
                  cursor: 'pointer',
                  background: '#f8f9ff'
                }
              },
                h('div', { style: { fontSize: '40px', marginBottom: '10px' } }, 'ğŸ“'),
                h('div', { style: { fontSize: '16px', fontWeight: 'bold', marginBottom: '5px' } }, 
                  this.state.csvFile ? 'âœ… ' + this.state.csvFile : 'Klik untuk upload file CSV'
                ),
                h('div', { style: { fontSize: '14px', color: '#666' } }, 
                  'Format: No;Nama;Jurusan'
                ),
                h('input', {
                  type: 'file',
                  accept: '.csv',
                  onChange: this.handleFileUpload,
                  style: { display: 'none' }
                })
              )
            ),

            // Error Message
            this.state.error && h('div', { 
              style: { 
                padding: '10px',
                background: '#fee',
                border: '1px solid #fcc',
                borderRadius: '4px',
                marginBottom: '15px',
                color: '#c00'
              }
            }, 'âŒ ' + this.state.error),

            // Data Table
            data.length > 0 && h('div', { style: { marginBottom: '15px' } },
              h('div', { 
                style: { 
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '10px'
                }
              },
                h('strong', {}, 'Total: ' + data.length + ' alumni'),
                h('button', {
                  type: 'button',
                  onClick: this.handleAdd,
                  style: {
                    padding: '8px 16px',
                    background: '#0066cc',
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: 'pointer'
                  }
                }, 'â• Tambah Alumni')
              ),
              
              h('div', { style: { overflowX: 'auto' } },
                h('table', { 
                  style: { 
                    width: '100%',
                    borderCollapse: 'collapse',
                    background: 'white'
                  }
                },
                  h('thead', {},
                    h('tr', { style: { background: '#f5f5f5' } },
                      h('th', { style: { padding: '10px', border: '1px solid #ddd', width: '80px' } }, 'No'),
                      h('th', { style: { padding: '10px', border: '1px solid #ddd' } }, 'Nama'),
                      h('th', { style: { padding: '10px', border: '1px solid #ddd', width: '200px' } }, 'Jurusan'),
                      h('th', { style: { padding: '10px', border: '1px solid #ddd', width: '100px' } }, 'Aksi')
                    )
                  ),
                  h('tbody', {},
                    data.map(function(item, index) {
                      return h('tr', { key: index },
                        h('td', { style: { padding: '8px', border: '1px solid #ddd' } },
                          h('input', {
                            type: 'text',
                            value: item.no,
                            onChange: function(e) { self.handleEdit(index, 'no', e.target.value); },
                            style: { width: '100%', padding: '4px', border: '1px solid #ccc', borderRadius: '3px' }
                          })
                        ),
                        h('td', { style: { padding: '8px', border: '1px solid #ddd' } },
                          h('input', {
                            type: 'text',
                            value: item.name,
                            onChange: function(e) { self.handleEdit(index, 'name', e.target.value); },
                            style: { width: '100%', padding: '4px', border: '1px solid #ccc', borderRadius: '3px' }
                          })
                        ),
                        h('td', { style: { padding: '8px', border: '1px solid #ddd' } },
                          h('input', {
                            type: 'text',
                            value: item.program,
                            onChange: function(e) { self.handleEdit(index, 'program', e.target.value); },
                            style: { width: '100%', padding: '4px', border: '1px solid #ccc', borderRadius: '3px' }
                          })
                        ),
                        h('td', { style: { padding: '8px', border: '1px solid #ddd', textAlign: 'center' } },
                          h('button', {
                            type: 'button',
                            onClick: function() { self.handleDelete(index); },
                            style: {
                              padding: '4px 12px',
                              background: '#dc3545',
                              color: 'white',
                              border: 'none',
                              borderRadius: '3px',
                              cursor: 'pointer'
                            }
                          }, 'ğŸ—‘ï¸ Hapus')
                        )
                      );
                    })
                  )
                )
              )
            )
          );
        }
      });

      // Preview Component (simpler)
      var CSVAlumniPreview = createClass({
        render: function() {
          var value = this.props.value || [];
          return h('div', {},
            h('strong', {}, 'Total: ' + value.length + ' alumni'),
            value.length > 0 && h('ul', { style: { marginTop: '10px' } },
              value.slice(0, 5).map(function(item, i) {
                return h('li', { key: i }, item.no + '. ' + item.name + ' - ' + item.program);
              }),
              value.length > 5 && h('li', {}, '... dan ' + (value.length - 5) + ' alumni lainnya')
            )
          );
        }
      });

      // Register the widget
      CMS.registerWidget('csv-alumni', CSVAlumniWidget, CSVAlumniPreview);
    </script>
  </body>
</html>