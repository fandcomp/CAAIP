<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CAAIP CMS</title>
    <link rel="icon" href="/favicon.svg" />
    <link rel="cms-config-url" href="/admin/config.yml" />
    <!-- Netlify Identity widget (required for git-gateway login UI) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <script>
      // Refresh page after a successful Identity login so CMS picks up the session
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', function(user){
          if (!user) {
            window.netlifyIdentity.on('login', function(){ document.location.reload(); });
          }
        });
      }
    </script>
    <!-- Load Decap CMS from jsDelivr (pinned) -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.8.4/dist/decap-cms.js"></script>
    
    <!-- Custom CSV Upload Widget -->
    <script>
      // Register custom CSV widget
      CMS.registerWidget('csv-upload', {
        // Control component - rendered in the editor
        controlComponent: class extends React.Component {
          constructor(props) {
            super(props);
            this.state = {
              csvData: props.value || [],
              uploading: false,
              error: null
            };
          }

          componentDidMount() {
            // If there's existing data, use it
            if (this.props.value && this.props.value.length > 0) {
              this.setState({ csvData: this.props.value });
            }
          }

          handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Check if CSV file
            if (!file.name.endsWith('.csv')) {
              this.setState({ error: 'File harus berformat .csv' });
              return;
            }

            this.setState({ uploading: true, error: null });

            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const text = event.target.result;
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                const parsedData = [];

                // Skip header row (first line)
                for (let i = 1; i < lines.length; i++) {
                  const line = lines[i];
                  if (line) {
                    // Split by semicolon and trim each value
                    const parts = line.split(';').map(p => p.trim());
                    
                    if (parts.length >= 2) {
                      parsedData.push({
                        no: parts[0] || String(i),
                        name: parts[1] || '',
                        program: parts[2] || ''
                      });
                    }
                  }
                }

                this.setState({ 
                  csvData: parsedData, 
                  uploading: false 
                });
                
                // Update the field value
                this.props.onChange(parsedData);

              } catch (err) {
                this.setState({ 
                  error: 'Gagal memproses file CSV: ' + err.message,
                  uploading: false 
                });
              }
            };

            reader.onerror = () => {
              this.setState({ 
                error: 'Gagal membaca file',
                uploading: false 
              });
            };

            reader.readAsText(file);
          };

          handleEdit = (index, field, value) => {
            const newData = [...this.state.csvData];
            newData[index][field] = value;
            this.setState({ csvData: newData });
            this.props.onChange(newData);
          };

          handleDelete = (index) => {
            const newData = this.state.csvData.filter((_, i) => i !== index);
            this.setState({ csvData: newData });
            this.props.onChange(newData);
          };

          handleAdd = () => {
            const newData = [...this.state.csvData, {
              no: String(this.state.csvData.length + 1),
              name: '',
              program: ''
            }];
            this.setState({ csvData: newData });
            this.props.onChange(newData);
          };

          render() {
            const { csvData, uploading, error } = this.state;

            return React.createElement('div', { style: { padding: '20px', border: '1px solid #ddd', borderRadius: '4px' } },
              // Upload section
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '10px',
                    fontWeight: 'bold',
                    fontSize: '14px'
                  } 
                }, 'Upload File CSV Alumni'),
                React.createElement('input', {
                  type: 'file',
                  accept: '.csv',
                  onChange: this.handleFileUpload,
                  disabled: uploading,
                  style: {
                    padding: '10px',
                    border: '2px dashed #ccc',
                    borderRadius: '4px',
                    width: '100%',
                    cursor: 'pointer'
                  }
                }),
                React.createElement('p', { 
                  style: { 
                    fontSize: '12px', 
                    color: '#666', 
                    marginTop: '5px' 
                  } 
                }, 'Format: No;Nama;Jurusan (gunakan semicolon sebagai pemisah)')
              ),

              // Error message
              error && React.createElement('div', {
                style: {
                  padding: '10px',
                  backgroundColor: '#fee',
                  border: '1px solid #fcc',
                  borderRadius: '4px',
                  color: '#c00',
                  marginBottom: '15px'
                }
              }, error),

              // Uploading indicator
              uploading && React.createElement('div', {
                style: {
                  padding: '10px',
                  backgroundColor: '#eff',
                  border: '1px solid #cff',
                  borderRadius: '4px',
                  color: '#066',
                  marginBottom: '15px'
                }
              }, 'Memproses file...'),

              // Data table
              csvData.length > 0 && React.createElement('div', { style: { marginTop: '20px' } },
                React.createElement('div', {
                  style: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '10px'
                  }
                },
                  React.createElement('strong', { style: { fontSize: '14px' } }, 
                    `Total: ${csvData.length} alumni`
                  ),
                  React.createElement('button', {
                    type: 'button',
                    onClick: this.handleAdd,
                    style: {
                      padding: '5px 15px',
                      backgroundColor: '#4CAF50',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '12px'
                    }
                  }, '+ Tambah Alumni')
                ),

                React.createElement('div', {
                  style: {
                    maxHeight: '400px',
                    overflowY: 'auto',
                    border: '1px solid #ddd',
                    borderRadius: '4px'
                  }
                },
                  React.createElement('table', {
                    style: {
                      width: '100%',
                      borderCollapse: 'collapse'
                    }
                  },
                    React.createElement('thead', {},
                      React.createElement('tr', {
                        style: {
                          backgroundColor: '#f5f5f5',
                          position: 'sticky',
                          top: 0
                        }
                      },
                        React.createElement('th', { style: { padding: '10px', textAlign: 'left', borderBottom: '2px solid #ddd', width: '60px' } }, 'No'),
                        React.createElement('th', { style: { padding: '10px', textAlign: 'left', borderBottom: '2px solid #ddd' } }, 'Nama'),
                        React.createElement('th', { style: { padding: '10px', textAlign: 'left', borderBottom: '2px solid #ddd', width: '150px' } }, 'Jurusan'),
                        React.createElement('th', { style: { padding: '10px', textAlign: 'center', borderBottom: '2px solid #ddd', width: '80px' } }, 'Aksi')
                      )
                    ),
                    React.createElement('tbody', {},
                      csvData.map((row, index) =>
                        React.createElement('tr', { 
                          key: index,
                          style: { 
                            backgroundColor: index % 2 === 0 ? 'white' : '#f9f9f9' 
                          } 
                        },
                          React.createElement('td', { style: { padding: '8px', borderBottom: '1px solid #eee' } },
                            React.createElement('input', {
                              type: 'text',
                              value: row.no,
                              onChange: (e) => this.handleEdit(index, 'no', e.target.value),
                              style: {
                                width: '100%',
                                padding: '4px',
                                border: '1px solid #ddd',
                                borderRadius: '3px'
                              }
                            })
                          ),
                          React.createElement('td', { style: { padding: '8px', borderBottom: '1px solid #eee' } },
                            React.createElement('input', {
                              type: 'text',
                              value: row.name,
                              onChange: (e) => this.handleEdit(index, 'name', e.target.value),
                              style: {
                                width: '100%',
                                padding: '4px',
                                border: '1px solid #ddd',
                                borderRadius: '3px'
                              }
                            })
                          ),
                          React.createElement('td', { style: { padding: '8px', borderBottom: '1px solid #eee' } },
                            React.createElement('input', {
                              type: 'text',
                              value: row.program,
                              onChange: (e) => this.handleEdit(index, 'program', e.target.value),
                              style: {
                                width: '100%',
                                padding: '4px',
                                border: '1px solid #ddd',
                                borderRadius: '3px'
                              }
                            })
                          ),
                          React.createElement('td', { 
                            style: { 
                              padding: '8px', 
                              borderBottom: '1px solid #eee',
                              textAlign: 'center' 
                            } 
                          },
                            React.createElement('button', {
                              type: 'button',
                              onClick: () => this.handleDelete(index),
                              style: {
                                padding: '4px 8px',
                                backgroundColor: '#f44336',
                                color: 'white',
                                border: 'none',
                                borderRadius: '3px',
                                cursor: 'pointer',
                                fontSize: '11px'
                              }
                            }, 'Hapus')
                          )
                        )
                      )
                    )
                  )
                )
              )
            );
          }
        },

        // Preview component - rendered in the preview pane
        previewComponent: class extends React.Component {
          render() {
            const data = this.props.value || [];
            if (data.length === 0) {
              return React.createElement('p', {}, 'Belum ada data alumni');
            }

            return React.createElement('div', {},
              React.createElement('p', {}, `Total: ${data.length} alumni`),
              React.createElement('ul', {},
                data.slice(0, 10).map((row, i) =>
                  React.createElement('li', { key: i }, 
                    `${row.no}. ${row.name} - ${row.program}`
                  )
                ),
                data.length > 10 && React.createElement('li', {}, `... dan ${data.length - 10} alumni lainnya`)
              )
            );
          }
        }
      });
    </script>
  </body>
  </html>
