<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CAAIP CMS</title>
    <link rel="icon" href="/favicon.svg" />
    <link rel="cms-config-url" href="/admin/config.yml" />
    <!-- Netlify Identity widget (required for git-gateway login UI) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <script>
      // Initialize Netlify Identity with your Netlify site URL
      if (window.netlifyIdentity) {
        window.netlifyIdentity.init({
          APIUrl: 'https://caaip.netlify.app/.netlify/identity'
        });
      }
      
      // Refresh page after a successful Identity login so CMS picks up the session
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', function(user){
          if (!user) {
            window.netlifyIdentity.on('login', function(){ document.location.reload(); });
          }
        });
      }
    </script>
    <!-- Load Decap CMS from jsDelivr (pinned) -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.8.4/dist/decap-cms.js"></script>
    
    <!-- Custom CSV Upload Widget -->
    <script>
      // Wait for CMS to be ready
      CMS.registerEventListener({
        name: 'preSave',
        handler: ({ entry }) => {
          console.log('Saving entry:', entry);
          return entry;
        }
      });

      // Custom CSV Upload Widget for Alumni
      var CSVAlumniWidget = createClass({
        getInitialState: function() {
          return {
            value: this.props.value || [],
            csvFile: null,
            error: null
          };
        },

        handleFileUpload: function(e) {
          var file = e.target.files[0];
          if (!file) return;

          if (!file.name.endsWith('.csv')) {
            this.setState({ error: 'File harus berformat .csv' });
            return;
          }

          var reader = new FileReader();
          var self = this;

          reader.onload = function(event) {
            try {
              var csv = event.target.result;
              var lines = csv.split('\n').filter(line => line.trim());
              
              // Skip header (first line)
              var dataLines = lines.slice(1);
              
              // Parse CSV with semicolon delimiter
              var parsedData = dataLines.map(function(line, index) {
                var cols = line.split(';').map(col => col.trim());
                return {
                  no: cols[0] || (index + 1).toString(),
                  name: cols[1] || '',
                  program: cols[2] || ''
                };
              }).filter(item => item.name); // Filter out empty names

              self.setState({ 
                value: parsedData,
                error: null,
                csvFile: file.name
              });
              
              // Update CMS value
              self.props.onChange(parsedData);
            } catch (err) {
              self.setState({ error: 'Error parsing CSV: ' + err.message });
            }
          };

          reader.onerror = function() {
            self.setState({ error: 'Error reading file' });
          };

          reader.readAsText(file);
        },

        handleEdit: function(index, field, newValue) {
          var newData = this.state.value.slice();
          newData[index][field] = newValue;
          this.setState({ value: newData });
          this.props.onChange(newData);
        },

        handleDelete: function(index) {
          var newData = this.state.value.filter((_, i) => i !== index);
          this.setState({ value: newData });
          this.props.onChange(newData);
        },

        handleAdd: function() {
          var newData = this.state.value.slice();
          newData.push({
            no: (newData.length + 1).toString(),
            name: '',
            program: ''
          });
          this.setState({ value: newData });
          this.props.onChange(newData);
        },

        render: function() {
          var self = this;
          var data = this.state.value || [];

          return h('div', { style: { padding: '15px', border: '1px solid #ddd', borderRadius: '4px' } },
            // Upload Section
            h('div', { style: { marginBottom: '20px' } },
              h('label', { 
                style: { 
                  display: 'block',
                  padding: '30px',
                  border: '2px dashed #0066cc',
                  borderRadius: '8px',
                  textAlign: 'center',
                  cursor: 'pointer',
                  background: '#f8f9ff'
                }
              },
                h('div', { style: { fontSize: '40px', marginBottom: '10px' } }, 'ðŸ“'),
                h('div', { style: { fontSize: '16px', fontWeight: 'bold', marginBottom: '5px' } }, 
                  this.state.csvFile ? 'âœ… ' + this.state.csvFile : 'Klik untuk upload file CSV'
                ),
                h('div', { style: { fontSize: '14px', color: '#666' } }, 
                  'Format: No;Nama;Jurusan'
                ),
                h('input', {
                  type: 'file',
                  accept: '.csv',
                  onChange: this.handleFileUpload,
                  style: { display: 'none' }
                })
              )
            ),

            // Error Message
            this.state.error && h('div', { 
              style: { 
                padding: '10px',
                background: '#fee',
                border: '1px solid #fcc',
                borderRadius: '4px',
                marginBottom: '15px',
                color: '#c00'
              }
            }, 'âŒ ' + this.state.error),

            // Data Table
            data.length > 0 && h('div', { style: { marginBottom: '15px' } },
              h('div', { 
                style: { 
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '10px'
                }
              },
                h('strong', {}, 'Total: ' + data.length + ' alumni'),
                h('button', {
                  type: 'button',
                  onClick: this.handleAdd,
                  style: {
                    padding: '8px 16px',
                    background: '#0066cc',
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: 'pointer'
                  }
                }, 'âž• Tambah Alumni')
              ),
              
              h('div', { style: { overflowX: 'auto' } },
                h('table', { 
                  style: { 
                    width: '100%',
                    borderCollapse: 'collapse',
                    background: 'white'
                  }
                },
                  h('thead', {},
                    h('tr', { style: { background: '#f5f5f5' } },
                      h('th', { style: { padding: '10px', border: '1px solid #ddd', width: '80px' } }, 'No'),
                      h('th', { style: { padding: '10px', border: '1px solid #ddd' } }, 'Nama'),
                      h('th', { style: { padding: '10px', border: '1px solid #ddd', width: '200px' } }, 'Jurusan'),
                      h('th', { style: { padding: '10px', border: '1px solid #ddd', width: '100px' } }, 'Aksi')
                    )
                  ),
                  h('tbody', {},
                    data.map(function(item, index) {
                      return h('tr', { key: index },
                        h('td', { style: { padding: '8px', border: '1px solid #ddd' } },
                          h('input', {
                            type: 'text',
                            value: item.no,
                            onChange: function(e) { self.handleEdit(index, 'no', e.target.value); },
                            style: { width: '100%', padding: '4px', border: '1px solid #ccc', borderRadius: '3px' }
                          })
                        ),
                        h('td', { style: { padding: '8px', border: '1px solid #ddd' } },
                          h('input', {
                            type: 'text',
                            value: item.name,
                            onChange: function(e) { self.handleEdit(index, 'name', e.target.value); },
                            style: { width: '100%', padding: '4px', border: '1px solid #ccc', borderRadius: '3px' }
                          })
                        ),
                        h('td', { style: { padding: '8px', border: '1px solid #ddd' } },
                          h('input', {
                            type: 'text',
                            value: item.program,
                            onChange: function(e) { self.handleEdit(index, 'program', e.target.value); },
                            style: { width: '100%', padding: '4px', border: '1px solid #ccc', borderRadius: '3px' }
                          })
                        ),
                        h('td', { style: { padding: '8px', border: '1px solid #ddd', textAlign: 'center' } },
                          h('button', {
                            type: 'button',
                            onClick: function() { self.handleDelete(index); },
                            style: {
                              padding: '4px 12px',
                              background: '#dc3545',
                              color: 'white',
                              border: 'none',
                              borderRadius: '3px',
                              cursor: 'pointer'
                            }
                          }, 'ðŸ—‘ï¸ Hapus')
                        )
                      );
                    })
                  )
                )
              )
            )
          );
        }
      });

      // Preview Component (simpler)
      var CSVAlumniPreview = createClass({
        render: function() {
          var value = this.props.value || [];
          return h('div', {},
            h('strong', {}, 'Total: ' + value.length + ' alumni'),
            value.length > 0 && h('ul', { style: { marginTop: '10px' } },
              value.slice(0, 5).map(function(item, i) {
                return h('li', { key: i }, item.no + '. ' + item.name + ' - ' + item.program);
              }),
              value.length > 5 && h('li', {}, '... dan ' + (value.length - 5) + ' alumni lainnya')
            )
          );
        }
      });

      // Register the widget
      CMS.registerWidget('csv-alumni', CSVAlumniWidget, CSVAlumniPreview);
    </script>
  </body>
</html>